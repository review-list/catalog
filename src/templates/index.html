<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ site_name }}</title>
  <meta name="description" content="{{ site_name }} の作品一覧です。" />

  {% if css_path %}
    <link rel="stylesheet" href="{{ css_path }}">
  {% endif %}

  <style>
    /* 最低限の検索UI（既存CSSを壊さないため控えめ） */
    .controls{
      margin: 14px 0 18px;
      display: grid;
      gap: 10px;
    }
    .controls .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .controls input[type="search"], .controls select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      min-width: 220px;
    }
    .controls button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .count{
      color: rgba(0,0,0,.55);
      font-size: 14px;
      margin-left: auto;
    }

    /* 作品カードの“フィルタ用”に非表示制御 */
    .is-hidden{ display:none !important; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="container">
      <div class="brand">
        <a href="{{ home_href or './' }}" style="text-decoration:none; color:inherit;">
          <strong>{{ site_name }}</strong>
        </a>
      </div>

      <nav class="nav" style="margin-top:10px; display:flex; gap:12px; flex-wrap:wrap;">
        <a href="{{ home_href or './' }}">ホーム</a>
        <a href="{{ actresses_href or 'actresses/' }}">女優</a>
        <a href="{{ genres_href or 'genres/' }}">ジャンル</a>
        <a href="{{ pages_href }}">全作品を見る（ページ）</a>
        <a href="{{ search_href }}">検索</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 style="margin:16px 0 8px;">作品一覧</h1>

    <!-- ✅ 検索＆絞り込み -->
    <section class="controls" aria-label="検索と絞り込み">
      <div class="row">
        <input id="q" type="search" placeholder="タイトル / 女優 / タグで検索" autocomplete="off">
        <select id="actress">
          <option value="">女優（すべて）</option>
          {% for a in (actresses_keys or []) %}
            <option value="{{ a }}">{{ a }}</option>
          {% endfor %}
        </select>
        <select id="tag">
          <option value="">タグ（すべて）</option>
          {% for g in (genres_keys or []) %}
            <option value="{{ g }}">{{ g }}</option>
          {% endfor %}
        </select>
        <button id="reset" type="button">リセット</button>

        <div class="count">
          <span id="shown">0</span> / <span id="total">0</span> 件
        </div>
      </div>
    </section>

    <!-- ✅ 一覧 -->
    <section class="grid" id="works">
      {% for w in works %}
        {# フィルタ用のテキストを data- に持たせる #}
        {% set actress_text = (w.actresses or []) | join(' ') %}
        {% set tag_text = (w.tags or []) | join(' ') %}

        <article class="card work-item"
          data-title="{{ (w.title or '') | lower }}"
          data-actresses="{{ actress_text | lower }}"
          data-tags="{{ tag_text | lower }}"
        >
          {% if w.hero_image %}
            <img class="thumb" src="{{ w.hero_image }}" alt="{{ w.title }}" loading="lazy">
          {% endif %}

          <div class="pad">
            <h2 class="title" style="margin:0 0 6px; font-size:18px;">
              {{ w.title }}
            </h2>

            {% if w.release_date %}
              <div class="meta">公開日：{{ w.release_date }}</div>
            {% endif %}

            {% if w.actresses %}
              <div class="tags" style="margin-top:10px;">
                {% for a in w.actresses %}
                  <span class="tag">{{ a }}</span>
                {% endfor %}
              </div>
            {% endif %}

            {% if w.tags %}
              <div class="tags" style="margin-top:10px;">
                {% for t in w.tags[:8] %}
                  <span class="tag">{{ t }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <div class="actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
              <a class="btn secondary" href="{{ works_prefix }}{{ w.id }}/">詳細を見る</a>
              {% if w.official_url %}
                <a class="btn" href="{{ w.official_url }}" target="_blank" rel="noopener">公式ページを見る</a>
              {% endif %}
            </div>
          </div>
        </article>
      {% endfor %}
    </section>

    <footer class="footer" style="margin:22px 0 30px; color:rgba(0,0,0,.5); text-align:center;">
      © 2026 {{ site_name }}
    </footer>
  </main>

  <script>
    (function(){
      const q = document.getElementById("q");
      const actress = document.getElementById("actress");
      const tag = document.getElementById("tag");
      const reset = document.getElementById("reset");

      const items = Array.from(document.querySelectorAll(".work-item"));
      const shownEl = document.getElementById("shown");
      const totalEl = document.getElementById("total");

      totalEl.textContent = String(items.length);

      function norm(s){ return (s || "").toString().trim().toLowerCase(); }

      function apply(){
        const kw = norm(q.value);
        const a = norm(actress.value);
        const t = norm(tag.value);

        let shown = 0;

        for (const el of items){
          const title = el.dataset.title || "";
          const as = el.dataset.actresses || "";
          const tags = el.dataset.tags || "";

          const okKw = !kw || (title.includes(kw) || as.includes(kw) || tags.includes(kw));
          const okA  = !a  || as.includes(a);
          const okT  = !t  || tags.includes(t);

          const ok = okKw && okA && okT;

          el.classList.toggle("is-hidden", !ok);
          if (ok) shown++;
        }

        shownEl.textContent = String(shown);
      }

      q.addEventListener("input", apply);
      actress.addEventListener("change", apply);
      tag.addEventListener("change", apply);
      reset.addEventListener("click", function(){
        q.value = "";
        actress.value = "";
        tag.value = "";
        apply();
        q.focus();
      });

      apply();
    })();
  </script>
</body>
</html>
