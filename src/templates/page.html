{% extends "_base.html" %}
{% block content %}
<section class="container">
  <div class="work-top">
    <div class="hero hero--work">
      {% if w.hero_image %}
        <button class="hero-btn" id="openHero" type="button" aria-label="ç”»åƒã‚’æ‹¡å¤§">
          <img src="{{ w.hero_image }}" alt="{{ w.title }}">
        </button>
      {% else %}
        <div class="thumb-placeholder hero-placeholder"></div>
      {% endif %}
    </div>

    <h1 class="page-title work-title--detail">{{ w.title }}</h1>

    <div class="badges-row">
      {% if w._has_img %}
        <span class="badge badge-img">ğŸ–¼ï¸ ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚ã‚Š{% if w._img_count %}ï¼ˆ{{ w._img_count }}æšï¼‰{% endif %}</span>
      {% endif %}
      {% if w._has_mov %}
        <span class="badge badge-mov">ğŸ¬ ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»ã‚ã‚Š</span>
      {% endif %}
    </div>

    {% if w.official_url %}
      <div class="cta cta--detail">
        <a class="btn btn-official btn-official--xl" href="{{ w.official_url }}" target="_blank" rel="noopener">å…¬å¼ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</a>
      </div>
    {% endif %}

    <dl class="info-list info-list--detail">
      {% if w.release_date %}
        <div class="info-row"><dt>ç™ºå£²æ—¥</dt><dd>{{ w.release_date }}</dd></div>
      {% endif %}

      {% if w.actresses and w.actresses|length > 0 %}
        <div class="info-row"><dt>å¥³å„ª</dt>
          <dd class="chips">
            {% for a in w.actresses %}
              <a class="chip" href="{{ root_path }}actresses/{{ a|slugify }}/">{{ a }}</a>
            {% endfor %}
          </dd>
        </div>
      {% endif %}

      {% if w.tags and w.tags|length > 0 %}
        <div class="info-row"><dt>ã‚¸ãƒ£ãƒ³ãƒ«</dt>
          <dd class="chips">
            {% for g in w.tags %}
              <a class="chip" href="{{ root_path }}genres/{{ g|slugify }}/">{{ g }}</a>
            {% endfor %}
          </dd>
        </div>
      {% endif %}

      {% if w.maker %}
        <div class="info-row"><dt>ãƒ¡ãƒ¼ã‚«ãƒ¼</dt><dd class="chips"><a class="chip" href="{{ root_path }}makers/{{ w.maker|slugify }}/">{{ w.maker }}</a></dd></div>
      {% endif %}
      {% if w.series %}
        <div class="info-row"><dt>ã‚·ãƒªãƒ¼ã‚º</dt><dd class="chips"><a class="chip" href="{{ root_path }}series/{{ w.series|slugify }}/">{{ w.series }}</a></dd></div>
      {% endif %}
      {% if w.label %}
        <div class="info-row"><dt>ãƒ¬ãƒ¼ãƒ™ãƒ«</dt><dd>{{ w.label }}</dd></div>
      {% endif %}
    </dl>

    {% if w.description %}
      <div class="desc">
        <h2 class="section-title">æ¦‚è¦</h2>
        <p class="desc-text">{{ w.description }}</p>
      </div>
    {% endif %}
  </div>

<div class="work-media-sections">
    {% if w.sample_movie %}
      <div class="media-block">
        <div class="media-head">
          <h2 class="section-title">ã‚µãƒ³ãƒ—ãƒ«å‹•ç”»</h2>
          <a class="muted-link" href="{{ w.sample_movie }}" target="_blank" rel="noopener">åˆ¥ã‚¿ãƒ–ã§é–‹ã</a>
        </div>

        <div class="video-embed" style="aspect-ratio: {{ video_aspect_ratio }};">
          <!-- ä½™ç™½ãŒå‡ºã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§ã€iframeã¯å°‘ã—æ‹¡å¤§ã—ã¦ä¸­å¤®ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¾ã™ -->
          <iframe
            src="{{ w.sample_movie }}"
            title="sample movie"
            allow="autoplay; fullscreen; picture-in-picture"
            referrerpolicy="no-referrer-when-downgrade"
            loading="lazy"
          ></iframe>
        </div>
      </div>
    {% endif %}

    {% if grid_images and grid_images|length > 0 %}
      <div class="media-block">
        <div class="media-head">
          <h2 class="section-title">ã‚µãƒ³ãƒ—ãƒ«ç”»åƒ</h2>
                  </div>

        <div class="sample-grid" id="sampleGrid">
          {% for img in grid_images %}
            <button class="sample-thumb {{ 'is-hidden' if loop.index > 6 else '' }}" type="button" data-idx="{{ loop.index0 }}">
              <img loading="lazy" src="{{ img }}" alt="sample {{ loop.index }}">
            </button>
          {% endfor %}
        </div>

        {% if grid_images|length > 6 %}
          <button class="btn btn-ghost" id="showMoreImages" type="button">ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ®‹ã‚Š{{ grid_images|length - 6 }}æšï¼‰</button>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% if related_actress and related_actress|length > 0 %}
    <h2 class="section-title">åŒã˜å¥³å„ªã®é–¢é€£ä½œå“</h2>
    <div class="works-grid works-grid--small">
      {% for rw in related_actress %}
        <a class="work-card" href="{{ root_path }}works/{{ rw.id }}/" aria-label="{{ rw.title }}">
          <div class="work-thumb">
            {% if rw.hero_image %}
              <img loading="lazy" src="{{ rw.hero_image }}" alt="{{ rw.title }}">
            {% else %}
              <div class="thumb-placeholder"></div>
            {% endif %}
            <div class="work-badges">
              {% if rw._has_img %}<span class="badge badge-img">ğŸ–¼ï¸</span>{% endif %}
              {% if rw._has_mov %}<span class="badge badge-mov">ğŸ¬</span>{% endif %}
            </div>
          </div>
          <div class="work-meta">
            <div class="work-title">{{ rw.title }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  {% if related_genre and related_genre|length > 0 %}
    <h2 class="section-title">åŒã‚¸ãƒ£ãƒ³ãƒ«ã®é–¢é€£ä½œå“</h2>
    <div class="works-grid works-grid--small">
      {% for rw in related_genre %}
        <a class="work-card" href="{{ root_path }}works/{{ rw.id }}/" aria-label="{{ rw.title }}">
          <div class="work-thumb">
            {% if rw.hero_image %}
              <img loading="lazy" src="{{ rw.hero_image }}" alt="{{ rw.title }}">
            {% else %}
              <div class="thumb-placeholder"></div>
            {% endif %}
            <div class="work-badges">
              {% if rw._has_img %}<span class="badge badge-img">ğŸ–¼ï¸</span>{% endif %}
              {% if rw._has_mov %}<span class="badge badge-mov">ğŸ¬</span>{% endif %}
            </div>
          </div>
          <div class="work-meta">
            <div class="work-title">{{ rw.title }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  {% if related_maker and related_maker|length > 0 %}
    <h2 class="section-title">åŒãƒ¡ãƒ¼ã‚«ãƒ¼ã®é–¢é€£ä½œå“</h2>
    <div class="works-grid works-grid--small">
      {% for rw in related_maker %}
        <a class="work-card" href="{{ root_path }}works/{{ rw.id }}/" aria-label="{{ rw.title }}">
          <div class="work-thumb">
            {% if rw.hero_image %}
              <img loading="lazy" src="{{ rw.hero_image }}" alt="{{ rw.title }}">
            {% else %}
              <div class="thumb-placeholder"></div>
            {% endif %}
            <div class="work-badges">
              {% if rw._has_img %}<span class="badge badge-img">ğŸ–¼ï¸</span>{% endif %}
              {% if rw._has_mov %}<span class="badge badge-mov">ğŸ¬</span>{% endif %}
            </div>
          </div>
          <div class="work-meta">
            <div class="work-title">{{ rw.title }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

  {% if related_series and related_series|length > 0 %}
    <h2 class="section-title">åŒã‚·ãƒªãƒ¼ã‚ºã®é–¢é€£ä½œå“</h2>
    <div class="works-grid works-grid--small">
      {% for rw in related_series %}
        <a class="work-card" href="{{ root_path }}works/{{ rw.id }}/" aria-label="{{ rw.title }}">
          <div class="work-thumb">
            {% if rw.hero_image %}
              <img loading="lazy" src="{{ rw.hero_image }}" alt="{{ rw.title }}">
            {% else %}
              <div class="thumb-placeholder"></div>
            {% endif %}
            <div class="work-badges">
              {% if rw._has_img %}<span class="badge badge-img">ğŸ–¼ï¸</span>{% endif %}
              {% if rw._has_mov %}<span class="badge badge-mov">ğŸ¬</span>{% endif %}
            </div>
          </div>
          <div class="work-meta">
            <div class="work-title">{{ rw.title }}</div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}
</section>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" hidden>
  <button class="lightbox-close" id="lbClose" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
  <button class="lightbox-nav lightbox-prev" id="lbPrev" type="button" aria-label="å‰ã¸">â€¹</button>
  <button class="lightbox-nav lightbox-next" id="lbNext" type="button" aria-label="æ¬¡ã¸">â€º</button>
  <div class="lightbox-stage" id="lbStage" role="dialog" aria-modal="true">
    <img id="lbImg" class="lightbox-img" alt="">
  </div>
</div>

<script>
(() => {
  const images = {{ lightbox_images|tojson }};
  if (!images || images.length === 0) return;

  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lbImg');
  const btnClose = document.getElementById('lbClose');
  const btnPrev = document.getElementById('lbPrev');
  const btnNext = document.getElementById('lbNext');
  const stage = document.getElementById('lbStage');
  const openHero = document.getElementById('openHero');
  const grid = document.getElementById('sampleGrid');
  const showMore = document.getElementById('showMoreImages');

  let idx = 0;

  function openAt(i){
    idx = Math.max(0, Math.min(images.length - 1, i));
    lbImg.src = images[idx];
    lbImg.alt = `image ${idx+1} / ${images.length}`;
    lb.hidden = false;
    document.body.classList.add('no-scroll');
  }

  function close(){
    lb.hidden = true;
    document.body.classList.remove('no-scroll');
  }

  function prev(){ openAt((idx - 1 + images.length) % images.length); }
  function next(){ openAt((idx + 1) % images.length); }

  btnClose?.addEventListener('click', close);
  btnPrev?.addEventListener('click', prev);
  btnNext?.addEventListener('click', next);

  lb?.addEventListener('click', (e) => {
    // stage å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    if (e.target === lb) close();
  });

  stage?.addEventListener('click', (e) => {
    // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§å·¦å³ç§»å‹•ï¼ˆç›´æ„Ÿï¼‰
    const rect = stage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    if (x < rect.width * 0.45) prev();
    else if (x > rect.width * 0.55) next();
  });

  document.addEventListener('keydown', (e) => {
    if (lb.hidden) return;
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight') next();
  });

  openHero?.addEventListener('click', () => openAt(0));

  // grid thumb click -> hero(0) + samples... ã®2æšç›®ä»¥é™ã«å¯¾å¿œ
  grid?.addEventListener('click', (e) => {
    const btn = e.target.closest('button.sample-thumb');
    if (!btn) return;
    const gridIdx = Number(btn.dataset.idx || '0');
    // heroãŒå…ˆé ­ã«ã‚ã‚‹å ´åˆã€gridã¯ã‚µãƒ³ãƒ—ãƒ«ç”»åƒãªã®ã§ +1
    const hasHero = images[0] === (document.querySelector('#openHero img')?.getAttribute('src') || '');
    const start = hasHero ? 1 : 0;
    openAt(start + gridIdx);
  });

  showMore?.addEventListener('click', () => {
    grid?.querySelectorAll('.sample-thumb.is-hidden')?.forEach(el => el.classList.remove('is-hidden'));
    showMore.remove();
  });
})();
</script>

<!-- JSON-LD (light) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "name": {{ w.title|tojson }},
  "datePublished": {{ w.release_date|tojson }},
  "url": {{ canonical_url|tojson }}
}
</script>
{% endblock %}
